<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>delta downscaling â€¢ pastclim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="delta downscaling">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pastclim</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.1.0.9003</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a0_pastclim_overview.html">pastclim overview</a></li>
    <li><a class="dropdown-item" href="../articles/a1_available_datasets.html">available datasets</a></li>
    <li><a class="dropdown-item" href="../articles/a2_custom_datasets.html">custom dataset</a></li>
    <li><a class="dropdown-item" href="../articles/a3_pastclim_present_and_future.html">present and future</a></li>
    <li><a class="dropdown-item" href="../articles/a4_delta_downscale_d.html">delta downscaling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href=".././pastclim_cheatsheet.pdf">Cheatsheet</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EvolEcolGroup/pastclim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>delta downscaling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/pastclim/blob/dev/vignettes/a4_delta_downscale_d.Rmd" class="external-link"><code>vignettes/a4_delta_downscale_d.Rmd</code></a></small>
      <div class="d-none name"><code>a4_delta_downscale_d.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="downscaling">Downscaling<a class="anchor" aria-label="anchor" href="#downscaling"></a>
</h2>
<p>Climate reconstructions from global circulation models are often at
coarser resolutions than desired for ecological analyses. Downscaling is
the process of generating a finer resolution raster from a coarser
resolution raster. There are many methods to downscale rasters, and
several are implemented in specific <code>R</code> packages. For
example, the <code>terra</code> package can downscale reconstructions
using bilinear interpolation, a statistical approach that is simple and
fast. For palaeoclimate reconstructions, the delta method has been shown
to be very effective (Beyer et al, REF). The delta method is a simple
method that computes the difference between the observed and modelled
values at a given time step (generally the present), and then applies
this difference to the modelled values at other time steps. This
approach makes the important assumption that the fine scale structure of
the deviations between large scale model and finer scale observations is
constant over time. Whilst such an assumption is likely to hold
reasonably well in the short term, it may not hold over longer time
scales.</p>
<div class="section level3">
<h3 id="delta-downscaling-a-dataset-in-pastclim">Delta downscaling a dataset in <code>pastclim</code><a class="anchor" aria-label="anchor" href="#delta-downscaling-a-dataset-in-pastclim"></a>
</h3>
<p><code>pastclim</code> includes functions to use the delta method for
downscaling. In this example, we will focus on Europe, as it shows
nicely the issues of sea level change and ice sheets, which need to be
accounted for when applying the delta downscale method. For real
applications, we would recommend using a bigger extent in areas of large
changes in land extent, as interpolating over a small extent can lead to
greater artefacts; for this example, we keep the extent small to reduce
computational time.</p>
</div>
<div class="section level3">
<h3 id="an-example-for-one-variable">An example for one variable<a class="anchor" aria-label="anchor" href="#an-example-for-one-variable"></a>
</h3>
<p>Whilst we are often interested in downscaling composite bioclimatic
variables (such as the warmest quarter), downscaling should be applied
directly to monthly estimates of temperature and precipitation, and high
resolution bioclimatic variables should be computed from these
downscaled monthly estimates. This approach ensures that the downscaled
bioclimatic variables are consistent with each other.</p>
<p>For downscaling, we will use the WorldClim2 dataset as our high
resolution observations. We will use the Example dataset (a subset of
the Beyer2020 dataset) as our low resolution model reconstructions. We
start by extracting monthly temperature for northern Europe for both
datasets:</p>
<pre><code><span><span class="co">#&gt; Loading required package: terra</span></span>
<span><span class="co">#&gt; terra 1.8.26</span></span></code></pre>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/pastclim" class="external-link">pastclim</a></span><span class="op">)</span></span>
<span><span class="va">tavg_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"temperature_0"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"temperature_"</span>,<span class="fl">10</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_steps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_time_bp_steps.html">get_time_bp_steps</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"Example"</span><span class="op">)</span></span>
<span><span class="va">n_europe_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">15</span>,<span class="fl">45</span>,<span class="fl">60</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_dataset.html">download_dataset</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"Beyer2020"</span>, bio_variables <span class="op">=</span> <span class="va">tavg_vars</span><span class="op">)</span></span>
<span><span class="va">tavg_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span>bio_variables <span class="op">=</span> <span class="va">tavg_vars</span>,</span>
<span>                             time_bp <span class="op">=</span>  <span class="va">time_steps</span>,</span>
<span>                             dataset <span class="op">=</span> <span class="st">"Beyer2020"</span>,</span>
<span>                              ext <span class="op">=</span> <span class="va">n_europe_ext</span><span class="op">)</span></span></code></pre></div>
<p>Downscaling is performed one variable at a time. We will start with
temperature in January. So, we first need to extract the
<code>SpatRaster</code> of model low resolution data from the
<code>SpatRasterDataset</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tavg_model_lres_rast</span> <span class="op">&lt;-</span> <span class="va">tavg_series</span><span class="op">$</span><span class="va">temperature_01</span></span>
<span><span class="va">tavg_model_lres_rast</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 30, 50, 5  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.5, 0.5  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -10, 15, 45, 60  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       :   temper~-20000,   temper~-15000,   temper~-10000,   temper~_-5000,   temper~e_01_0 </span></span>
<span><span class="co">#&gt; min values  :     -23.3037052,      -15.498360,      -11.794130,       -8.754138,       -9.613334 </span></span>
<span><span class="co">#&gt; max values  :      -0.1343476,        3.690956,        6.295014,        7.745749,        6.616667 </span></span>
<span><span class="co">#&gt; unit        : degrees Celsius, degrees Celsius, degrees Celsius, degrees Celsius, degrees Celsius </span></span>
<span><span class="co">#&gt; time (years): -18050 to 1950</span></span></code></pre></div>
<p>And we can now plot it:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span>, main <span class="op">=</span> <span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>We can see how that the reconstructions are rather coarse (the
Beyer2020 dataset uses 0.5x0.5 degree cells). We now need a set of high
resolutions observations for the variable of interest that we will use
to generate the delta raster used to downscale reconstructions. We will
use data from WorldClim2 at 10 minute resolution (but other datasets
such as CHELSA would be equally suitable):</p>
<p>Once the variable is downloaded, we can load it at any time with:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_dataset.html">download_dataset</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>, bio_variables <span class="op">=</span> <span class="va">tavg_vars</span><span class="op">)</span></span>
<span><span class="va">tavg_obs_hres_all</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span>bio_variables <span class="op">=</span> <span class="va">tavg_vars</span>,</span>
<span>                             time_ce <span class="op">=</span>  <span class="fl">1985</span>,</span>
<span>                             dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>,</span>
<span>                              ext <span class="op">=</span> <span class="va">n_europe_ext</span><span class="op">)</span></span></code></pre></div>
<p>For later use, we store the range of the variable, which we will use
to bound the downscaled values (arguably, it would be better to grab
these limits from the full world distribution, but for this example, we
will use the European range)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tavg_obs_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">tavg_obs_hres_all</span>,<span class="va">minmax</span>, compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tavg_obs_range</span></span>
<span><span class="co">#&gt; [1] -10.40350  24.43275</span></span></code></pre></div>
<p>We want to crop these reconstructions to the extent of interest</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tavg_obs_hres_all</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">tavg_obs_hres_all</span>, <span class="va">n_europe_ext</span><span class="op">)</span></span>
<span><span class="co"># extract the January raster</span></span>
<span><span class="va">tavg_obs_hres_rast</span> <span class="op">&lt;-</span> <span class="va">tavg_obs_hres_all</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tavg_obs_hres_rast</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-12-1.png" width="384"></p>
<p>We need to make sure that the extent of the modern observations is
the same as the extent of the model reconstructions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">tavg_obs_hres_rast</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>If that was not the case, we would use <code><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">terra::crop</a></code> to
match the extents.</p>
<p>We also need a high resolution global relief map (i.e.Â integrating
both topographic and bathymetric values) to reconstruct past coastlines
following sea level change. We can download the ETOPO2022 relief data,
and resample to match the extent and resolution as the high resolution
observations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_etopo.html">download_etopo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">relief_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_etopo.html">load_etopo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">relief_rast</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">relief_rast</span>, <span class="va">tavg_obs_hres_rast</span><span class="op">)</span></span></code></pre></div>
<p>We can now generate a high resolution land mask for the periods of
interest. By default, we use the sea level reconstructions from Spratt
et al 2016, but a different reference can be used by setting sea levels
for each time step (see the man page for <code>make_land_mask</code> for
details):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">land_mask_high_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_land_mask.html">make_land_mask</a></span><span class="op">(</span>relief_rast <span class="op">=</span> <span class="va">relief_rast</span>, </span>
<span>                                time_bp <span class="op">=</span> <span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">land_mask_high_res</span>, main<span class="op">=</span><span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">land_mask_high_res</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-17-1.png" width="576"></p>
<p>Note that this land mask does take ice sheets into account, and the
Black and Caspian sea are missing. For the ice mask, we can:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ice_mask_low_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ice_mask.html">get_ice_mask</a></span><span class="op">(</span>time_bp<span class="op">=</span><span class="va">time_steps</span>,dataset<span class="op">=</span><span class="st">"Beyer2020"</span><span class="op">)</span></span>
<span><span class="va">ice_mask_high_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downscale_ice_mask.html">downscale_ice_mask</a></span> <span class="op">(</span>ice_mask_low_res <span class="op">=</span> <span class="va">ice_mask_low_res</span>,</span>
<span>                                    land_mask_high_res <span class="op">=</span> <span class="va">land_mask_high_res</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ice_mask_high_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>Note that there is no ice mask for the last two time steps.</p>
<p>We can now remove the ice mask from the land mask:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">land_mask_high_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">land_mask_high_res</span>, </span>
<span>                                <span class="va">ice_mask_high_res</span>, </span>
<span>                                inverse<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">land_mask_high_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>If it was a region with internal seas, we could then remove them
with:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">internal_seas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/internal_seas.RDS"</span>,</span>
<span>                                       package<span class="op">=</span><span class="st">"pastclim"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">land_mask_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">land_mask_high_res</span>, </span>
<span>                                <span class="va">internal_seas</span>, </span>
<span>                                inverse<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can now compute a delta raster and use it to downscale the model
reconstructions:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delta_rast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/delta_compute.html">delta_compute</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tavg_model_lres_rast</span>, ref_time <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                     obs <span class="op">=</span> <span class="va">tavg_obs_hres_rast</span><span class="op">)</span></span>
<span><span class="va">model_downscaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/delta_downscale.html">delta_downscale</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">tavg_model_lres_rast</span>, </span>
<span>                                                delta_rast <span class="op">=</span> <span class="va">delta_rast</span>,</span>
<span>                                                x_landmask_high <span class="op">=</span> <span class="va">land_mask_high_res</span>,</span>
<span>                                                range_limits<span class="op">=</span><span class="va">tavg_obs_range</span><span class="op">)</span></span>
<span><span class="va">model_downscaled</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 90, 150, 5  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -10, 15, 45, 60  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       : temper~-20000, temper~-15000, temper~-10000, temper~_-5000, temper~e_01_0 </span></span>
<span><span class="co">#&gt; min values  :    -10.403500,     -10.40350,    -10.403500,     -9.289666,    -10.300500 </span></span>
<span><span class="co">#&gt; max values  :      1.350215,       4.70648,      7.546785,      8.997520,      7.445105 </span></span>
<span><span class="co">#&gt; time (years): -18050 to 1950</span></span></code></pre></div>
<p>Letâ€™s inspect the resulting data:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/panel.html" class="external-link">panel</a></span><span class="op">(</span><span class="va">model_downscaled</span>, main <span class="op">=</span> <span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">model_downscaled</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-24-1.png" width="576"></p>
<p>And, as a reminder, the original reconstructions:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/panel.html" class="external-link">panel</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span>, main <span class="op">=</span> <span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">tavg_model_lres_rast</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-25-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="computing-the-bioclim-variables">Computing the bioclim variables<a class="anchor" aria-label="anchor" href="#computing-the-bioclim-variables"></a>
</h3>
<p>To compute the bioclim variables, we need to repeat the procedure
above for temperature and precipitation for all months. Let us start
with temperature. We loop over each month, create a
<code>SpatRaster</code> of downscaled temperature, add it to a list, and
finally convert the list into a <code>SpatRasterDataset</code></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tavg_downscaled_list</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">delta_rast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/delta_compute.html">delta_compute</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tavg_series</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, ref_time <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                       obs <span class="op">=</span> <span class="va">tavg_obs_hres_all</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">tavg_downscaled_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/delta_downscale.html">delta_downscale</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">tavg_series</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                                                  delta_rast <span class="op">=</span> <span class="va">delta_rast</span>,</span>
<span>                                                  x_landmask_high <span class="op">=</span> <span class="va">land_mask_high_res</span>,</span>
<span>                                                  range_limits<span class="op">=</span><span class="va">tavg_obs_range</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">tavg_downscaled</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sds.html" class="external-link">sds</a></span><span class="op">(</span><span class="va">tavg_downscaled_list</span><span class="op">)</span></span></code></pre></div>
<p>Quickly inspect the resulting dataset:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tavg_downscaled</span></span>
<span><span class="co">#&gt; class       : SpatRasterDataset </span></span>
<span><span class="co">#&gt; subdatasets : 12 </span></span>
<span><span class="co">#&gt; dimensions  : 90, 150 (nrow, ncol)</span></span>
<span><span class="co">#&gt; nlyr        : 5, 5, 5, 5, 5, 5, 5, 5, 5 </span></span>
<span><span class="co">#&gt; resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -10, 15, 45, 60  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span></code></pre></div>
<p>As expected, we have 12 months (subdatasets), each with 5 time
steps.</p>
<p>We now want to repeat the same procedure for precipitation. In this
example we will downscale precipitation in its natural scale, but often
we use logs. We now need to create a series for precipitation:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"precipitation_0"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"precipitation_"</span>,<span class="fl">10</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prec_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span>bio_variables <span class="op">=</span> <span class="va">prec_vars</span>,</span>
<span>                             time_bp <span class="op">=</span>  <span class="va">time_steps</span>,</span>
<span>                             dataset <span class="op">=</span> <span class="st">"Beyer2020"</span>,</span>
<span>                             ext <span class="op">=</span> <span class="va">n_europe_ext</span><span class="op">)</span></span></code></pre></div>
<p>Get some high resolution observations:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_dataset.html">download_dataset</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>, bio_variables <span class="op">=</span> <span class="va">prec_vars</span><span class="op">)</span></span>
<span><span class="va">prec_obs_hres_all</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span>bio_variables <span class="op">=</span> <span class="va">prec_vars</span>,</span>
<span>                             time_ce <span class="op">=</span>  <span class="fl">1985</span>,</span>
<span>                             dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>,</span>
<span>                              ext <span class="op">=</span> <span class="va">n_europe_ext</span><span class="op">)</span></span></code></pre></div>
<p>Estimate the range of observed precipitation:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec_obs_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">prec_obs_hres_all</span>,<span class="va">minmax</span>, compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prec_obs_range</span></span>
<span><span class="co">#&gt; [1]  10 365</span></span></code></pre></div>
<p>And finally downscale precipitation:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec_downscaled_list</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">delta_rast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/delta_compute.html">delta_compute</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">prec_series</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, ref_time <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                       obs <span class="op">=</span> <span class="va">prec_obs_hres_all</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">prec_downscaled_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/delta_downscale.html">delta_downscale</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">prec_series</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                                                  delta_rast <span class="op">=</span> <span class="va">delta_rast</span>,</span>
<span>                                                  x_landmask_high <span class="op">=</span> <span class="va">land_mask_high_res</span>,</span>
<span>                                                  range_limits <span class="op">=</span> <span class="va">prec_obs_range</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">prec_downscaled</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sds.html" class="external-link">sds</a></span><span class="op">(</span><span class="va">prec_downscaled_list</span><span class="op">)</span></span></code></pre></div>
<p>We are now ready to compute the bioclim variables:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bioclim_downscaled</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bioclim_vars-methods.html">bioclim_vars</a></span><span class="op">(</span>tavg <span class="op">=</span> <span class="va">tavg_downscaled</span>, prec <span class="op">=</span> <span class="va">prec_downscaled</span><span class="op">)</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span>
<span><span class="co">#&gt; varnames was empty, so we will use the names to label the layers</span></span></code></pre></div>
<p>Letâ€™s inspect the object:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bioclim_downscaled</span></span>
<span><span class="co">#&gt; class       : SpatRasterDataset </span></span>
<span><span class="co">#&gt; subdatasets : 17 </span></span>
<span><span class="co">#&gt; dimensions  : 90, 150 (nrow, ncol)</span></span>
<span><span class="co">#&gt; nlyr        : 5, 5, 5, 5, 5, 5, 5, 5, 5 </span></span>
<span><span class="co">#&gt; resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -10, 15, 45, 60  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory </span></span>
<span><span class="co">#&gt; names       : bio01, bio04, bio05, bio06, bio07, bio08, ...</span></span></code></pre></div>
<p>And plot the first variable (bio01):</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/panel.html" class="external-link">panel</a></span><span class="op">(</span><span class="va">bioclim_downscaled</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">bioclim_downscaled</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
<p>We can now save the downscaled <code>sds</code> to a netcdf file:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeCDF.html" class="external-link">writeCDF</a></span><span class="op">(</span><span class="va">bioclim_downscaled</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"/EA_bioclim_downscaled.nc"</span><span class="op">)</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>And then use it as a custom dataset for any function in
<code>pastclim</code>. Letâ€™s extract a region series for three
variables:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span>bio_variables <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio01"</span>,<span class="st">"bio04"</span>,<span class="st">"bio19"</span><span class="op">)</span>,</span>
<span>                             dataset <span class="op">=</span> <span class="st">"custom"</span>,</span>
<span>                             path_to_nc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"/EA_bioclim_downscaled.nc"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can quickly inspect the resulting <code>sds</code> object:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_data</span></span>
<span><span class="co">#&gt; class       : SpatRasterDataset </span></span>
<span><span class="co">#&gt; subdatasets : 3 </span></span>
<span><span class="co">#&gt; dimensions  : 90, 150 (nrow, ncol)</span></span>
<span><span class="co">#&gt; nlyr        : 5, 5, 5 </span></span>
<span><span class="co">#&gt; resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -10, 15, 45, 60  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : EA_bioclim_downscaled.nc </span></span>
<span><span class="co">#&gt; names       : bio01, bio04, bio19</span></span></code></pre></div>
<p>And plot it (it should be identical to the earlier plot obtained when
we created the dataset):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/panel.html" class="external-link">panel</a></span><span class="op">(</span><span class="va">custom_data</span><span class="op">$</span><span class="va">bio01</span>, main<span class="op">=</span><span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">custom_data</span><span class="op">$</span><span class="va">bio01</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a4_delta_downscale_d_files/figure-html/unnamed-chunk-42-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michela Leonardi, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
