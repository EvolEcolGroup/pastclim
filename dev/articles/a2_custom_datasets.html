<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>custom dataset • pastclim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="custom dataset">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pastclim</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.1.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a0_pastclim_overview.html">pastclim overview</a></li>
    <li><a class="dropdown-item" href="../articles/a1_available_datasets.html">available datasets</a></li>
    <li><a class="dropdown-item" href="../articles/a2_custom_datasets.html">custom dataset</a></li>
    <li><a class="dropdown-item" href="../articles/a3_pastclim_present_and_future.html">present and future</a></li>
    <li><a class="dropdown-item" href="../articles/a4_delta_downscale_d.html">delta downscaling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href=".././pastclim_cheatsheet.pdf">Cheatsheet</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EvolEcolGroup/pastclim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>custom dataset</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/pastclim/blob/dev/vignettes/a2_custom_datasets.Rmd" class="external-link"><code>vignettes/a2_custom_datasets.Rmd</code></a></small>
      <div class="d-none name"><code>a2_custom_datasets.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="formatting-a-custom-dataset-for-pastclim">Formatting a custom dataset for <code>pastclim</code><a class="anchor" aria-label="anchor" href="#formatting-a-custom-dataset-for-pastclim"></a>
</h3>
<p>This guide is aimed at formatting data in such a way that they can be
used with <code>pastclim</code>. <code>pastclim</code> is designed to
extract data from <code>netcdf</code> files, a format commonly used for
storing climate reconstructions. <code>netcdf</code> files have a number
of advantages, as they can store compressed information, as well as
allowing access to only the data required (e.g. extracting only the time
steps or location of interest without reading all the data in memory).
The expected format for <code>pastclim</code> requires that all time
steps of a given variable be stored within a single netcdf file. How
variables are combined (or not) is then flexible: you can have a
separate file for each variable, collate everything within a single
file, or create multiple files each including a number of variables. The
time variable should be in years since 1950 (i.e. with negative integers
indicating the past). There are a number of command line tools as well
as R libraries (e.g. <code>cdo</code>, <code>gdal</code>,
<code>terra</code>) that can help creating and editing netcdf files.</p>
</div>
<div class="section level3">
<h3 id="an-example-the-trace21k-chelsea">An example: the Trace21k-CHELSEA<a class="anchor" aria-label="anchor" href="#an-example-the-trace21k-chelsea"></a>
</h3>
<p>Here we provide a simple example of how to format such a dataset in
R. We will use a version of the Trace21k dataset, downscaled to 30
arcsecs using the CHELSEA algorithm(available from <a href="https://chelsa-climate.org/chelsa-trace21k/" class="external-link">this website</a>).
The data are stored as geoTIFF files, one file per time step per
variable. First, we need to collate all the files for a given variable
(we will use <em>bio01</em> as an example) within a single
<code>netcdf</code> file. As the original files are large, we will
illustrate here how do to that for only a few time steps which were
aggregated to 3x3 degrees to keep files sizes small.</p>
<p>We start by translating each geoTIFF into a <code>netcdf</code> file.
The files have the prefix
<em>CHELSA_TraCE21k_bio01_-<strong>xxx</strong>_V1.0.small.tif</em>,
where <strong>xxx</strong> is the number of the time step. We will only
use 3 time step for illustrative purposes.</p>
<p>We store all the files in a single directory, and create a
<code>spatRaster</code> from a list of the files in that directory:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tiffs_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/CHELSA_bio01"</span>, package <span class="op">=</span> <span class="st">"pastclim"</span><span class="op">)</span></span>
<span><span class="va">list_of_tiffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tiffs_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">tiffs_path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bio01</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">list_of_tiffs</span><span class="op">)</span></span></code></pre></div>
<p><em>NOTE: <code>terra</code> has changed the way it handles time when
reading from netcdf. The dev version of <code>terra</code> can more
easily format netcdf files correctly, but this vignette presents a
number of workarounds needed for the version on CRAN</em></p>
<p>Now we need to set the time axis of the raster (in this case,
reconstructions are every 100 years), and generate some user friendly
names to layers in the raster:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/pastclim" class="external-link">pastclim</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: terra</span></span>
<span><span class="co">#&gt; terra 1.7.81</span></span>
<span><span class="fu"><a href="../reference/time_bp.html">time_bp</a></span><span class="op">(</span><span class="va">bio01</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">100</span>, <span class="op">-</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bio01</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"bio01"</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">bio01</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span></code></pre></div>
<p>Now we save the data as a <em>nc</em> file (we will use the temporary
directory)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"CHELSA_TraCE21k_bio01.nc"</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeCDF.html" class="external-link">writeCDF</a></span><span class="op">(</span><span class="va">bio01</span>,</span>
<span>  filename <span class="op">=</span> <span class="va">nc_name</span>, varname <span class="op">=</span> <span class="st">"bio01"</span>,</span>
<span>  compression <span class="op">=</span> <span class="fl">9</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can now read in our custom netcdf file with
<code>pastclim</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/region_series.html">region_series</a></span><span class="op">(</span></span>
<span>  bio_variables <span class="op">=</span> <span class="st">"bio01"</span>,</span>
<span>  dataset <span class="op">=</span> <span class="st">"custom"</span>,</span>
<span>  path_to_nc <span class="op">=</span> <span class="va">nc_name</span></span>
<span><span class="op">)</span></span>
<span><span class="va">custom_series</span></span>
<span><span class="co">#&gt; class       : SpatRasterDataset </span></span>
<span><span class="co">#&gt; subdatasets : 1 </span></span>
<span><span class="co">#&gt; dimensions  : 174, 360 (nrow, ncol)</span></span>
<span><span class="co">#&gt; nlyr        : 3 </span></span>
<span><span class="co">#&gt; resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -180.0001, 179.9999, -90.00014, 83.99986  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">#&gt; source(s)   : CHELSA_TraCE21k_bio01.nc </span></span>
<span><span class="co">#&gt; names       : bio01</span></span></code></pre></div>
<p>As expected, there is only one variable (“bio01”) and 3 time steps
(nlyr). We can get the times of those time steps with:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_time_bp_steps.html">get_time_bp_steps</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"custom"</span>, path_to_nc <span class="op">=</span> <span class="va">nc_name</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]    0 -100 -200</span></span></code></pre></div>
<p>And we can slice the series and plot a given time point:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slice_region_series.html">slice_region_series</a></span><span class="op">(</span><span class="va">custom_series</span>, time_bp <span class="op">=</span> <span class="op">-</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">climate_100</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_custom_datasets_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Note that these reconstructions include the ocean and the ice sheets,
and it would be much better to remove them as they are not needed for
most ecological/archaeological studies (and it allows for smaller
files).</p>
</div>
<div class="section level2">
<h2 id="making-the-data-available-to-others">Making the data available to others<a class="anchor" aria-label="anchor" href="#making-the-data-available-to-others"></a>
</h2>
<p>Once you have created suitably formatted netcdf files that can be
used as custom datasets in <code>pastclim</code>, you can add those data
officially to the package, and thus make them available to others. Here
are the necessary steps:</p>
<ol style="list-style-type: decimal">
<li><p>Put your files in a freely available repository.</p></li>
<li><p>Update the table used by <code>pastclim</code> to store
information about available datasets. This table is found in
“./data-raw/data_files/dataset_list_included.csv”.</p></li>
</ol>
<pre><code><span><span class="co">#&gt;   variable ncvar dataset monthly                 file_name download_path</span></span>
<span><span class="co">#&gt; 1    bio01  BIO1 Example   FALSE example_climate_v1.3.0.nc              </span></span>
<span><span class="co">#&gt; 2    bio10 BIO10 Example   FALSE example_climate_v1.3.0.nc              </span></span>
<span><span class="co">#&gt;   download_function file_name_orig download_path_orig version</span></span>
<span><span class="co">#&gt; 1                                                       1.3.0</span></span>
<span><span class="co">#&gt; 2                                                       1.3.0</span></span>
<span><span class="co">#&gt;                             long_name      abbreviated_name time_frame</span></span>
<span><span class="co">#&gt; 1             annual mean temperature           ann. mean T       year</span></span>
<span><span class="co">#&gt; 2 mean temperature of warmest quarter mean T of warmest qtr       year</span></span>
<span><span class="co">#&gt;             units  units_exp dataset_list_v</span></span>
<span><span class="co">#&gt; 1 degrees Celsius *degree*C*          1.3.9</span></span>
<span><span class="co">#&gt; 2 degrees Celsius *degree*C*</span></span></code></pre>
<p>This includes the following fields:</p>
<p><code>variable</code>: the variable name used by
<code>pastclim</code></p>
<p><code>ncvar</code>: the variable name within the <em>nc</em> file (it
can be the same as <code>variable</code>)</p>
<p><code>dataset</code>: the name of the dataset.</p>
<p><code>monthly</code>: boolean on whether the variable is monthly.</p>
<p><code>file_name</code>: the name of the file for that variable.</p>
<p><code>download_path</code>: the URL to download the file.</p>
<p><code>donwload_function</code>: for datasets which can be easily
converted by the user into a valid netcdf, it is possibly to leave
<code>download_path</code> empty, and to create an internal function
that downloads and converts the files. For an example, see the WorldClim
datasets.</p>
<p><code>file_name_orig</code>: the name of the original file(s) used to
create the <em>nc</em> dataset.</p>
<p><code>download_path_orig</code>: the path of those original
files.</p>
<p><code>version</code>: the version of the dataset that you created</p>
<p><code>long_name</code>: the long name for the variable</p>
<p><code>abbreviated_name</code>: an abbreviated version of
<code>long_name</code> (used for plot labels)</p>
<p><code>time_frame</code>: either <code>year</code> or the appropriate
<code>month</code></p>
<p><code>units</code>: units for the variable, to be displayed in a
plain text table</p>
<p><code>units_exp</code>: units formatted to be included in
<code>expression</code> when creating plot labels</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Once you have added lines detailing the variables in your
dataset, run the script “./raw-data/make_data/dataset_list_included.R”
to store that information into the appropriate dataset in
<code>pastclim</code>.</p></li>
<li><p>Provide information on the new dataset in the file
“./R/dataset_docs”, using <code>roxygen2</code> syntax. Make sure that
you provide an appropriate reference for the original data, as it is
important that users can refer back to the original source.</p></li>
<li><p>Make a Pull Request on GitHub.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michela Leonardi, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
